stages:
  - build

build_project:
  stage: build
  image: ubuntu:22.04
  before_script:
    - echo "Starting build environment..."
    - apt-get update -qy
    - apt-get install -y build-essential 
    - apt-get install -y libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev freeglut3 libfreeimage-dev libfreeimage3
    - echo "System dependecy installation complete."

  script:
    - echo "Building the project..."
    - make
    - echo "Build complete."
    
    # Blocco unico per packaging e copia asset
    - |
      echo "--- Inizio Packaging ---"
      
      # Crea le cartelle di destinazione (fondamentale per evitare errori se non esistono)
      mkdir -p libs
      mkdir -p client/bin/Release/texture

      echo "--- 1. Copia librerie principali ---"
      # Usa || true per evitare che la pipeline fallisca se un file manca (opzionale, ma consigliato per debug)
      cp engine/bin/Release/libengine.so libs/
      cp /usr/lib/x86_64-linux-gnu/libglut.so.3 libs/
      cp /usr/lib/x86_64-linux-gnu/libfreeimage.so.3 libs/

      echo "--- 2. Copia suite OpenEXR ---"
      find /usr/lib -name "libIlm*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libImath*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libIex*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libHalf*.so*" -exec cp {} libs/ \;
      
      echo "--- 3. Copia dipendenze WebP e JXR ---"
      find /usr/lib -name "libwebp*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libsharpyuv*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libjxr*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libjpegxr*.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libopenjp2.so*" -exec cp {} libs/ \;
      
      echo "--- 4. Copia dipendenze generiche ---"
      find /usr/lib -name "libraw.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libpng16.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libtiff.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libdeflate.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libjbig.so*" -exec cp {} libs/ \;
      find /usr/lib -name "liblzma.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libzstd.so*" -exec cp {} libs/ \;
      find /usr/lib -name "libgomp.so*" -exec cp {} libs/ \;
      find /usr/lib -name "liblcms2.so*" -exec cp {} libs/ \;

      echo "--- 5. COPIA ASSET (Fix tavolo.ovo) ---"
      # Copia tavolo.ovo ESATTAMENTE accanto all'eseguibile
      cp client/tavolo.ovo client/bin/Release/
      
      # Copia le texture (il contenuto della cartella)
      # Nota: Assicurati che client/texture esista, altrimenti dar√† errore
      if [ -d "client/texture" ]; then
        cp -r client/texture/* client/bin/Release/texture/
      else
        echo "Warning: Cartella client/texture non trovata!"
      fi

      echo "Verifica contenuto cartella Release:"
      ls -l client/bin/Release/

  artifacts:
    name: "$CI_JOB_NAME-artifacts"
    expire_in: 1 week
    paths:
      - client/bin/Release/    # Contiene exe, ovo e texture
      - libs/                  # Contiene le librerie .so
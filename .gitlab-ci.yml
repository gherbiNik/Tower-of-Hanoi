stages:
  - structure
  - engine
  - client

# Usa l'immagine ufficiale del corso che ha gi√† i compilatori e le librerie (FreeImage, GL, ecc.)
image: gitlab-edu.supsi.ch:5050/dti-isin/labingsw/common:ubuntu2404-cg

structure:
  stage: structure
  script:
    - '[ -d engine ] || exit 1'
    - '[ -d client ] || exit 1'
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "main"

engine:
  stage: engine
  before_script:
    - cd engine
  script:
    - make clean
    - make release     # Compila la libreria
#    - make test       # Esegue i test unitari
  after_script:
    - cd ..
  artifacts:
    expire_in: 1 week
    paths:
      - engine/bin/Release/libengine.so
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "main"

client:
  stage: client
  dependencies:
    - engine # Scarica libengine.so generato nello stadio precedente
  before_script:
    - cd client
  script:
    - make clean
    - make release     # Compila l'eseguibile client
    
    # --- Gestione Asset (Mantenuta dal tuo script originale) ---
    - echo "Copying assets to Release folder..."
    # Copia il file tavolo.ovo (assumo sia nella root di client/)
    - cp tavolo.ovo bin/Release/
    # Copia la cartella texture
    - cp -r texture bin/Release/
    
    # Copia libengine.so vicino all'eseguibile per facilitare l'esecuzione locale se scarichi l'artefatto
    - cp ../engine/bin/Release/libengine.so bin/Release/
    
  after_script:
    - cd ..
  artifacts:
    name: "$CI_JOB_NAME-artifacts"
    expire_in: 1 week
    paths:
      - client/bin/Release/ # Contiene l'eseguibile, la libengine e gli asset
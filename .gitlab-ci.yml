stages:
  - build

build_project:
  stage: build
  image: ubuntu:22.04
  before_script:
    - echo "Starting build environment..."
    - apt-get update -qy
    - apt-get install -y build-essential 
    - apt-get install -y libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev freeglut3 libfreeimage-dev libfreeimage3
    - echo "System dependecy installation complete."

  script:
    - echo "Building the project..."
    - make
    - echo "Build complete."
    
    # --- CREAZIONE DEL PACCHETTO PORTATILE ---
    - mkdir -p libs

    # 1. Copiamo le librerie dirette (gi√† fatto prima)
    - cp /usr/lib/x86_64-linux-gnu/libglut.so.3 libs/
    - cp /usr/lib/x86_64-linux-gnu/libfreeimage.so.3 libs/
    
    # 2. Copiamo la TUA libreria engine (fondamentale per evitare l'errore precedente)
    - cp engine/bin/Release/libengine.so libs/

    # 3. Copiamo le dipendenze interne di FreeImage (risolvono l'errore attuale e il prossimo)
    # libjxrglue serve a FreeImage, libjxrlib serve a libjxrglue
    - cp /usr/lib/x86_64-linux-gnu/libjxrglue.so.0 libs/
    - cp /usr/lib/x86_64-linux-gnu/libjxrlib.so.0 libs/

  artifacts:
    name: "$CI_JOB_NAME-artifacts"
    expire_in: 1 week
    paths:
      - client/bin/Debug/client
      - client/bin/Release/client
      - engine/bin/Debug/libengine.so
      - engine/bin/Release/libengine.so
      - engine/bin/Debug/main.exe
      - engine/bin/Release/main.exe
      - libs/  # <--- IMPORTANTE: Aggiungi la cartella libs agli artifacts
stages:
  - structure
  - engine
  - client

image: gitlab-edu.supsi.ch:5050/dti-isin/labingsw/common:ubuntu2404-cg

structure:
  stage: structure
  script:
    - '[ -d engine ] || exit 1'
    - '[ -d client ] || exit 1'


engine:
  stage: engine
  before_script:
    - cd engine
  script:
    - make clean
    - make release
#   - make test
    # Verifica che la libreria sia stata creata
    - ls -l bin/Release/libengine.so
  after_script:
    - cd ..
  artifacts:
    name: "engine-lib"
    paths:
      # Ãˆ fondamentale che questo percorso sia ESATTO (relativo alla root del progetto)
      - engine/bin/Release/libengine.so
    expire_in: 1 week


client:
  stage: client
  needs: 
    - job: engine
      artifacts: true
  before_script:
    - cd client
  script:
    - make clean
    - make release

    # --- PACKAGING DELLE DIPENDENZE ---
    - echo "Inizio procedura di bundling..."
    
    - mkdir -p bin/Release/libs
    
    - echo "Copia Engine..."
    - cp ../engine/bin/Release/libengine.so bin/Release/libs/

    - echo "Copia GLUT e FreeImage..."
    - cp /usr/lib/x86_64-linux-gnu/libglut.so.3* bin/Release/libs/
    - cp /usr/lib/x86_64-linux-gnu/libfreeimage.so.3* bin/Release/libs/

    - echo "Copia dipendenze annidate (incluse JPEG mancanti)..."
    - |
      DEPENDENCIES=(
        "libIlm*" "libImath*" "libIex*" "libHalf*"    # Suite OpenEXR
        "libwebp*" "libsharpyuv*"                     # WebP
        "libjxr*" "libjpegxr*"                        # JXR / JPEG XR
        "libopenjp2*"                                 # JPEG 2000
        "libraw*" "libpng16*" "libtiff*"              # Formati Raw, PNG, Tiff
        "libjpeg*"                                    # <--- AGGIUNTO: Risolve l'errore libjpeg.so.8
        "libdeflate*" "libjbig*" "liblzma*"           # Compressione (dipendenze di Tiff/EXR)
        "libzstd*" "libgomp*" "liblcms2*"             # Compressione e Color Management
        "libbrotli*"                                  # Spesso richiesta da nuove versioni
      )
      
      # Ciclo su ogni pattern e copio nella cartella libs
      for pattern in "${DEPENDENCIES[@]}"; do
        find /usr/lib/x86_64-linux-gnu -name "$pattern" -exec cp -v {} bin/Release/libs/ \;
      done

    - echo "Copia Assets..."
    - cp tavolo.ovo bin/Release/
    - cp -r texture bin/Release/

    - echo "Generazione script di avvio..."
    - echo '#!/bin/bash' > bin/Release/run.sh
    # Dice a Linux: "Cerca le librerie PRIMA in ./libs, poi nel sistema"
    - echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./libs:.' >> bin/Release/run.sh
    - echo './client' >> bin/Release/run.sh
    - chmod +x bin/Release/run.sh
    
    - echo "Packaging completato."
    - ls -R bin/Release/

  after_script:
    - cd ..
  artifacts:
    paths:
      - client/bin/Release/

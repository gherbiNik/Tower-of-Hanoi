stages:
  - structure
  - engine
  - client

image: gitlab-edu.supsi.ch:5050/dti-isin/labingsw/common:ubuntu2404-cg

structure:
  stage: structure
  script:
    - '[ -d engine ] || exit 1'
    - '[ -d client ] || exit 1'


engine:
  stage: engine
  before_script:
    - cd engine
  script:
    - make clean
    - make release
#   - make test
    # Verifica che la libreria sia stata creata
    - ls -l bin/Release/libengine.so
  after_script:
    - cd ..
  artifacts:
    name: "engine-lib"
    paths:
      # Ãˆ fondamentale che questo percorso sia ESATTO (relativo alla root del progetto)
      - engine/bin/Release/libengine.so
    expire_in: 1 week


client:
  stage: client
  needs: 
    - job: engine
      artifacts: true
  before_script:
    - cd client
  script:
    - make clean
    - make release

    # --- PACKAGING ROBUSTO DELLE DIPENDENZE ---
    - echo "Inizio procedura di bundling..."
    - mkdir -p bin/Release/libs
    
    # Copia Engine
    - cp ../engine/bin/Release/libengine.so bin/Release/libs/

    # Copia dipendenze dirette (GLUT e FreeImage)
    # Usa -L per copiare il FILE REALE, risolvendo i symlink
    - cp -L /usr/lib/x86_64-linux-gnu/libglut.so.3* bin/Release/libs/
    - cp -L /usr/lib/x86_64-linux-gnu/libfreeimage.so.3* bin/Release/libs/

    - echo "Copia dipendenze annidate..."
    - |
      DEPENDENCIES=(
        "libOpenEXR*"                                 # <--- NUOVO: FONDAMENTALE per Ubuntu 24.04+
        "libIlm*" "libImath*" "libIex*" "libHalf*"    # Componenti legacy/ausiliari OpenEXR
        "libwebp*" "libsharpyuv*"                     # WebP
        "libjxr*" "libjpegxr*"                        # JXR
        "libopenjp2*"                                 # JPEG 2000
        "libraw*" "libpng16*" "libtiff*"              # Raw, PNG, Tiff
        "libjpeg*"                                    # JPEG standard
        "libdeflate*" "libjbig*" "liblzma*"           # Compressioni
        "libzstd*" "libgomp*" "liblcms2*"             # Utils
        "libbrotli*"                                  # Compressione Brotli
      )
      
      # Ciclo con find e cp -L (dereference) per prendere i file veri
      for pattern in "${DEPENDENCIES[@]}"; do
        find /usr/lib/x86_64-linux-gnu -name "$pattern" -exec cp -L -v {} bin/Release/libs/ \;
      done

    # Copia Assets
    - cp tavolo.ovo bin/Release/
    - cp -r texture bin/Release/

    # --- GENERAZIONE SCRIPT DI AVVIO INTELLIGENTE ---
    - echo "Generazione run.sh..."
    - echo '#!/bin/bash' > bin/Release/run.sh
    
    # 1. Trova la cartella dove risiede questo script (indipendentemente da dove lo lanci)
    - echo 'DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"' >> bin/Release/run.sh
    
    # 2. Imposta LD_LIBRARY_PATH aggiungendo la cartella libs locale
    - echo 'export LD_LIBRARY_PATH="$DIR/libs:$DIR:$LD_LIBRARY_PATH"' >> bin/Release/run.sh
    
    # 3. Lancia il client
    - echo '"$DIR/client"' >> bin/Release/run.sh
    
    - chmod +x bin/Release/run.sh
    
    # DEBUG: Verifica finale del contenuto
    - echo "Librerie copiate:"
    - ls -lh bin/Release/libs/

  after_script:
    - cd ..
  artifacts:
    paths:
      - client/bin/Release/

stages:
  - build

build_project:
  stage: build
  image: ubuntu:22.04
  before_script:
    - echo "Starting build environment..."
    - apt-get update -qy
    - apt-get install -y build-essential 
    - apt-get install -y libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev freeglut3 libfreeimage-dev libfreeimage3
    - echo "System dependecy installation complete."

  script:
      - echo "Building the project..."
      - make
      - echo "Build complete."
      
      # Blocco unico per la gestione librerie (pi√π sicuro contro errori di sintassi)
      - |
        mkdir -p libs
        
        echo "Coping primary libraries..."
        cp engine/bin/Release/libengine.so libs/
        cp /usr/lib/x86_64-linux-gnu/libglut.so.3 libs/
        cp /usr/lib/x86_64-linux-gnu/libfreeimage.so.3 libs/

        echo "Searching and copying dependencies..."
        # Usa find per trovare le dipendenze indipendentemente dal nome esatto
        find /usr/lib -name "libjxr*.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libjpegxr*.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libopenjp2.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libraw.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libwebp.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libpng16.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libtiff.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libImath*.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libIlmImf*.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libHalf*.so*" -exec cp {} libs/ \;
        find /usr/lib -name "libIex*.so*" -exec cp {} libs/ \;
        
        echo "Library packaging complete."
        ls -l libs/

  artifacts:
    name: "$CI_JOB_NAME-artifacts"
    expire_in: 1 week
    paths:
      - client/bin/Debug/client
      - client/bin/Release/client
      - engine/bin/Debug/libengine.so
      - engine/bin/Release/libengine.so
      - libs/